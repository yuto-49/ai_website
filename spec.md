# Notebook Chat - Technical Specification

## Overview

Notebook Chat is a conversational AI application inspired by Google's NotebookLM. It combines a chat interface with a visual mind map (Node Map) that displays conversation relationships and AI-generated ideas.

**Key Differentiator**: Unlike traditional chat apps, Notebook Chat visualizes the conversation structure as an interactive radial graph, enabling users to see how topics branch and relate to each other.

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend (React + Vite)                  │
│  ┌─────────┐  ┌──────────────┐  ┌─────────┐  ┌──────────────┐  │
│  │ Sidebar │  │ChatContainer │  │ NodeMap │  │ LayoutCache  │  │
│  └─────────┘  └──────────────┘  └─────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP POST /api/chat
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Backend (Flask + Python)                     │
│  ┌─────────────────┐    ┌────────────────────────────────────┐  │
│  │   Chat Handler  │───▶│      Agentic System (Parallel)     │  │
│  └─────────────────┘    │  ┌─────────────────────────────┐   │  │
│          │              │  │   Brainstorming Agent       │   │  │
│          ▼              │  │   (generates idea nodes)    │   │  │
│  ┌─────────────────┐    │  └─────────────────────────────┘   │  │
│  │  Claude API     │    │  ┌─────────────────────────────┐   │  │
│  │  (Anthropic)    │    │  │   Future: More Agents...    │   │  │
│  └─────────────────┘    │  └─────────────────────────────┘   │  │
│                         └────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### Tech Stack

| Layer    | Technology                          |
|----------|-------------------------------------|
| Frontend | React 18, Vite, React Router DOM 7  |
| Styling  | CSS Variables, Glassmorphism        |
| Backend  | Flask, Flask-CORS                   |
| AI       | Anthropic Claude API (Haiku/Sonnet) |
| State    | React useState/useCallback/useMemo  |

---

## Data Models

### Conversation
```javascript
{
  id: number,                    // Timestamp-based unique ID
  title: string,                 // Display title (auto-generated from first message)
  messages: Message[],           // Array of messages
  fromConversationId?: number,   // Parent conversation (for topic threads)
  isAiGenerated?: boolean,       // True if created by AI agent
  generatedBy?: string,          // Agent type that created it ("brainstorming")
  topicMeta?: {
    fromMessageId?: number,
    selectionRange?: { start: number, end: number },
    aiGenerated?: boolean,
    sourceAgent?: string
  }
}
```

### Message
```javascript
{
  id: number,           // Timestamp-based unique ID
  text: string,         // Message content
  sender: 'user' | 'ai'
}
```

### TopicEdge
```javascript
{
  conversationId: number,       // Child conversation ID
  fromConversationId: number,   // Parent conversation ID
  fromMessageId?: number,       // Source message (null for AI-generated)
  selectionRange?: { start: number, end: number },
  isAiGenerated?: boolean
}
```

### Layout Cache Entry
```javascript
{
  [rootId]: {
    version: number,
    nodes: {
      [nodeId]: {
        depth: number,       // Distance from root (0 = center)
        angle: number,       // Polar coordinate (radians)
        parentId: string,
        kind: 'root' | 'topic' | 'ai',
        createdAt: number
      }
    }
  }
}
```

---

## Frontend Components

### App.jsx (Main Controller)
**Location**: `src/App.jsx`

**Routes**:
- `/` - Chat view with optional split map panel
- `/map` - Full-page node map
- `/ideas/:parentId` - Cluster expansion view

**State Management**:
- `conversations` - All conversation objects
- `topicEdges` - Parent-child relationships
- `manualPositions` - User-dragged node positions (persisted to localStorage)
- `mapPanelState` - 'collapsed' | 'mini' | 'expanded'

**Key Functions**:
| Function | Purpose |
|----------|---------|
| `handleSendMessage()` | Sends message to API, processes response and agent results |
| `handleAgentResults()` | Dispatches agent outputs to appropriate handlers |
| `createAutoGeneratedNodes()` | Creates conversation nodes from brainstorming ideas |
| `handleExpandCluster()` | Navigates to `/ideas/:parentId` for cluster view |
| `handleCreateTopicFromSelection()` | Creates topic thread from highlighted text |
| `buildContextPack()` | Builds context for topic thread conversations |

### NodeMap.jsx (Visual Mind Map)
**Location**: `src/components/NodeMap.jsx`

**Purpose**: Renders radial graph visualization of conversation tree

**Features**:
- Radial layout with root at center
- Draggable nodes with position persistence
- Cluster grouping for AI-generated ideas (shows count badge)
- Hover highlighting of connected nodes
- Lock/unlock mode for editing vs. browsing
- Responsive to container resizing

**Key Logic**:
```javascript
// BFS tree building from root
const { nodes, links, clusters } = useMemo(() => {
  // Traverse conversation tree, group AI children into clusters
}, [rootId, byId, childrenOf]);

// Position calculation with cache fallback
const autoPositioned = useMemo(() => {
  // Try cache first, fallback to local radial calculation
}, [getPositions, rootId, nodes, size]);
```

### useLayoutCache.js (Position Stability Hook)
**Location**: `src/hooks/useLayoutCache.js`

**Purpose**: Maintains stable polar coordinates across renders/resizes

**Key Functions**:
| Function | Purpose |
|----------|---------|
| `updateLayout()` | Syncs node tree to cache, assigns angles to new nodes |
| `getPositions()` | Converts cached polar coords to Cartesian for current size |
| `getNodeLayout()` | Retrieves single node's cached layout data |

**Stability Pattern**:
```javascript
// Functions are stable (useCallback with [] deps)
// Return object is memoized to prevent infinite loops
return useMemo(() => ({
  cache, updateLayout, getPositions, clearCache
}), [cache, updateLayout, getPositions, clearCache]);
```

### Sidebar.jsx
**Location**: `src/components/Sidebar.jsx`

**Purpose**: Navigation and conversation list

**Features**:
- Tree structure display (parent/child indentation)
- Chats / Map tab navigation
- New chat button
- User profile section

### ChatContainer.jsx
**Location**: `src/components/ChatContainer.jsx`

**Purpose**: Wrapper for chat interface

**Children**: WelcomeScreen, MessageList, MessageInput

### Message.jsx
**Location**: `src/components/Message.jsx`

**Purpose**: Individual message with topic creation capability

**Features**:
- Text selection detection
- "Start Topic" popup on selection
- Topic badges showing linked conversations
- Precise selection range calculation for topic creation

---

## Backend System

### server.py

#### Endpoints

**POST /api/chat**
```
Request:
{
  message: string,
  contextPack?: ContextPack,
  conversationMessages?: Message[],
  enabledAgents?: string[]
}

Response:
{
  response: string,
  model: string,
  agentResults?: { [agentType]: AgentResult },
  topicSummary?: string
}
```

**GET /health**
```
Response: { status: "ok" }
```

#### Agent System

**AgentRegistry** - Configuration store:
```python
agents = {
    "brainstorming": {
        "name": "Brainstorming Agent",
        "model": "claude-3-haiku-20240307",
        "max_tokens": 300,
        "temperature": 0.9,
        "execution": "parallel"
    }
}
```

**AgentExecutor** - Parallel execution engine:
- Uses `ThreadPoolExecutor` for concurrent agent runs
- Supports parallel and sequential execution modes
- 10-second timeout per agent

**Brainstorming Agent**:
- Analyzes last 6 messages of conversation
- Generates 1-3 short, divergent topic ideas
- Returns ideas as array of strings

#### Topic Context System
For topic threads, builds context with:
- **Long-term memory**: Stable summary of parent conversation
- **Working memory**: Recent 2-4 conversation turns
- **Selection context**: The highlighted text that spawned the topic

---

## Key Features

### 1. Topic Threading
Users highlight text in AI responses → "Start Topic" button appears → Creates branching conversation with parent context preserved.

**Flow**:
```
User highlights "quantum entanglement" in AI response
    ↓
Click "Start Topic"
    ↓
New conversation created with:
  - fromConversationId = parent
  - fromMessageId = source message
  - selectionRange = { start, end }
    ↓
Topic badge appears on original message
```

### 2. AI Idea Generation
Brainstorming agent runs after each message, generating related topic suggestions.

**Flow**:
```
User sends message
    ↓
Backend processes with Claude API
    ↓
Brainstorming agent analyzes conversation
    ↓
Returns 1-3 idea strings
    ↓
Frontend creates conversation nodes (isAiGenerated: true)
    ↓
Ideas appear as cluster in Node Map
```

### 3. Visual Mind Map

**Layout Algorithm**:
- Root conversation at center (depth 0)
- Children in concentric rings by depth
- Angles assigned incrementally, preserved in cache
- New nodes fill "gaps" in existing angle distribution

**Cluster System**:
- Multiple AI ideas grouped into single "Ideas" node
- Shows count badge (e.g., "3")
- Click to expand into individual nodes at `/ideas/:parentId`

### 4. Split View
Three panel states:
- **Collapsed**: Full-width chat
- **Mini**: Chat + 320px map panel
- **Expanded**: 50/50 split

Toggle button cycles through states.

---

## Design Patterns

### 1. Stable Reference Pattern
**Problem**: Hook return objects change identity on state updates → infinite loops

**Solution**:
```javascript
// In useLayoutCache.js
const updateLayout = useCallback(() => { ... }, []);  // Stable
const getPositions = useCallback(() => { ... }, []);  // Stable

return useMemo(() => ({
  cache, updateLayout, getPositions
}), [cache, updateLayout, getPositions]);

// In NodeMap.jsx - destructure stable functions
const { updateLayout, getPositions } = layoutCache || {};
useEffect(() => {
  updateLayout(rootId, nodes, links);
}, [updateLayout, rootId, nodes, links]);  // No infinite loop
```

### 2. Fallback Calculation Pattern
**Problem**: Cache empty on first render

**Solution**:
```javascript
const autoPositioned = useMemo(() => {
  // Try cache
  if (getPositions) {
    const cached = getPositions(rootId, nodes, size);
    if (cached.size > 0) return { positions: cached };
  }
  // Fallback: calculate locally
  return calculatePositions(nodes, size);
}, [getPositions, rootId, nodes, size]);
```

### 3. Normalized Coordinates
**Problem**: Pixel positions break on resize

**Solution**:
```javascript
// Store as 0-1 ratio
onDrag: (x, y) => {
  const nx = x / containerWidth;
  const ny = y / containerHeight;
  savePosition(nodeId, { nx, ny });
}

// Render with current size
const x = position.nx * currentWidth;
const y = position.ny * currentHeight;
```

---

## Current Limitations

| Limitation | Impact |
|------------|--------|
| No persistence | Data lost on refresh (except manual positions in localStorage) |
| Single user | No auth, no multi-user collaboration |
| No streaming | AI responses arrive all at once |
| Limited agents | Only brainstorming implemented |
| No search | Cannot find past conversations |
| Model selector decorative | UI exists but doesn't change actual model |

---

## Improvement Ideas

### High Priority

#### 1. Data Persistence
```javascript
// Options:
// A) IndexedDB for client-side persistence
// B) SQLite/PostgreSQL backend
// C) Firebase/Supabase for real-time sync

// Minimal implementation:
useEffect(() => {
  localStorage.setItem('conversations', JSON.stringify(conversations));
}, [conversations]);
```

#### 2. Streaming Responses
```javascript
// Server-Sent Events approach
app.route('/api/chat/stream')
def stream_chat():
    def generate():
        for chunk in claude_stream:
            yield f"data: {chunk}\n\n"
    return Response(generate(), mimetype='text/event-stream')

// Frontend
const eventSource = new EventSource('/api/chat/stream');
eventSource.onmessage = (e) => appendChunk(e.data);
```

#### 3. Additional Agents

| Agent | Purpose | Priority |
|-------|---------|----------|
| **Summarizer** | Condense long conversations | High |
| **Fact Checker** | Verify claims via web search | Medium |
| **Code Analyzer** | Review code snippets | Medium |
| **Quiz Generator** | Create study questions | Low |
| **Translator** | Multi-language support | Low |

### Medium Priority

#### 4. Enhanced Node Map
- **Canvas rendering** for 100+ nodes (performance)
- **Zoom/pan** with smooth animations
- **Search** with node highlighting
- **Filters** by type, date, depth
- **Minimap** for navigation

#### 5. Rich Content
- **Markdown** rendering with syntax highlighting
- **File uploads** (PDF, images) as context
- **Voice input** via Web Speech API
- **LaTeX** for math expressions

#### 6. Collaboration
- **WebSocket sync** for real-time multi-user
- **Presence indicators** showing who's online
- **Comments** on nodes
- **Share links** with permissions

### Lower Priority

#### 7. Mobile Experience
- Touch-friendly node map gestures
- Responsive sidebar (drawer)
- PWA with offline support

#### 8. Plugin Architecture
```javascript
// Allow custom agents
registerAgent({
  name: 'my-agent',
  execute: async (messages) => { ... },
  config: { model: 'custom', temperature: 0.7 }
});
```

#### 9. Analytics
- Conversation statistics
- Topic clustering visualization
- Usage patterns over time

---

## File Structure

```
ai_website/
├── src/
│   ├── components/
│   │   ├── ChatContainer.jsx   # Chat wrapper
│   │   ├── Message.jsx         # Message + topic creation
│   │   ├── MessageInput.jsx    # Text input
│   │   ├── MessageList.jsx     # Message rendering
│   │   ├── NodeMap.jsx         # Mind map visualization
│   │   ├── NodeMapPage.jsx     # Full-page map wrapper
│   │   ├── Sidebar.jsx         # Navigation
│   │   ├── TypingIndicator.jsx # Loading dots
│   │   └── WelcomeScreen.jsx   # Empty state
│   ├── hooks/
│   │   └── useLayoutCache.js   # Position stability
│   ├── App.jsx                 # Main controller
│   ├── App.css                 # Component styles
│   ├── index.css               # CSS variables
│   └── main.jsx                # Entry point
├── server.py                   # Flask backend
├── vite.config.js              # Build config
├── package.json                # Dependencies
└── spec.md                     # This document
```

---

## Running the Application

```bash
# Frontend (Terminal 1)
npm install
npm run dev              # http://localhost:3000

# Backend (Terminal 2)
pip install flask flask-cors anthropic python-dotenv
export ANTHROPIC_API_KEY="sk-..."
python server.py         # http://localhost:5001
```

---

## API Quick Reference

### POST /api/chat
```json
// Request
{
  "message": "Explain quantum computing",
  "conversationMessages": [
    { "id": 1, "text": "Hello", "sender": "user" },
    { "id": 2, "text": "Hi!", "sender": "ai" }
  ],
  "enabledAgents": ["brainstorming"]
}

// Response
{
  "response": "Quantum computing uses...",
  "model": "claude-3-haiku-20240307",
  "agentResults": {
    "brainstorming": {
      "success": true,
      "ideas": ["Quantum supremacy", "Cryptography impact", "Current limitations"]
    }
  }
}
```

---

*Last updated: January 2025*
